<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数智环卫赋能平台 - 资金管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        
        .menu-item { display: flex; align-items: center; padding: 10px 16px; color: #4b5563; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .menu-item:hover { color: #3b82f6; background-color: #eff6ff; }
        .menu-item.active { color: #3b82f6; background-color: #eff6ff; border-right: 3px solid #3b82f6; }
        .submenu-item { padding-left: 48px; }
        
        .btn-blue-text { color: #1890ff; cursor: pointer; font-size: 14px; }
        .btn-blue-text:hover { color: #40a9ff; }
        
        .stat-card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; border-left: 4px solid transparent; height: 100%; }
        .stat-label { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-size: 24px; font-weight: bold; }

        /* Highlight viewing row */
        .viewing-row { background-color: #e6f7ff !important; }
        
        /* Modal Styles */
        .modal-section-title { font-weight: bold; font-size: 15px; color: #333; padding: 12px 0 8px 0; border-bottom: 1px solid #eee; margin-bottom: 0; }
        .info-grid { display: grid; grid-template-columns: 120px 1fr 120px 1fr; border-top: 1px solid #e5e7eb; border-left: 1px solid #e5e7eb; }
        .info-label { background-color: #f9fafb; padding: 10px 12px; font-size: 13px; color: #666; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; display: flex; align-items: center; }
        .info-value { padding: 10px 12px; font-size: 13px; color: #333; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; display: flex; align-items: center; background-color: white; word-break: break-all;}
        
        #btn-sys-reconcile { position: fixed; left: 20px; bottom: 20px; z-index: 100; background-color: #2563eb; color: white; padding: 8px 16px; border-radius: 4px; font-size: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s; }
        #btn-sys-reconcile:hover { background-color: #1d4ed8; transform: translateY(-2px); }
        #btn-sys-reconcile:active { transform: translateY(0); }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <button id="btn-sys-reconcile">系统对账 (模拟)</button>

    <header class="bg-blue-600 text-white h-12 flex items-center justify-between px-4 shrink-0 shadow-md z-50">
        <div class="flex items-center space-x-2"><span class="text-lg font-bold tracking-wide">数智环卫赋能平台</span></div>
        <div class="flex items-center space-x-4 text-sm">
            <span>① 严禁处理国家秘密和工作秘密信息</span>
            <div class="flex items-center space-x-2">
                <div class="w-6 h-6 rounded-full bg-blue-400 flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
                <span>管理员</span>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col overflow-y-auto shrink-0 pb-10">
            <div class="py-2">
                <div class="menu-item"><svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>工作台</div>
                <div class="menu-item"><svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>首页</div>
                <div>
                    <div class="menu-item text-blue-600">
                        <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span class="font-medium">收费管理</span>
                        <svg class="w-3 h-3 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="menu-item submenu-item"><span class="w-1 h-1 bg-gray-400 rounded-full mr-2"></span>收费契约</div>
                    <div class="menu-item submenu-item"><span class="w-1 h-1 bg-gray-400 rounded-full mr-2"></span>收费账单</div>
                    
                    <div id="nav-recon" class="menu-item submenu-item active" onclick="switchPage('recon')">
                        <span class="w-1 h-1 bg-blue-500 rounded-full mr-2"></span>已对账账单
                    </div>
                    <div id="nav-unrecon" class="menu-item submenu-item" onclick="switchPage('unrecon')">
                        <span class="w-1 h-1 bg-gray-400 rounded-full mr-2"></span>未对账账单
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-gray-100 p-4 overflow-hidden relative">
            
            <div id="view-recon" class="flex flex-col h-full space-y-4">
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm shrink-0">
                    <h2 class="text-lg font-bold text-gray-800">已对账账单看板</h2>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 text-sm">对账日期:</label>
                        <input id="overview-date-filter" type="date" class="border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-blue-400">
                        <button id="btn-query-recon" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-5 py-1.5 rounded">查询</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 shrink-0" style="height: 180px;">
                    <div class="grid grid-cols-2 grid-rows-2 gap-3 h-full">
                        <div class="stat-card border-l-blue-500">
                            <div class="stat-label">银行账单数</div>
                            <div class="stat-value text-gray-800" id="stat-bank-count">0</div>
                        </div>
                        <div class="stat-card border-l-red-500">
                            <div class="stat-label">对账失败帐单数</div>
                            <div class="stat-value text-red-600" id="stat-abnormal-count">0</div>
                        </div>
                        <div class="stat-card border-l-indigo-500">
                            <div class="stat-label">总金额</div>
                            <div class="stat-value text-gray-800" id="stat-total-amt">0.00</div>
                        </div>
                        <div class="stat-card border-l-green-500">
                            <div class="stat-label">对账成功总金额</div>
                            <div class="stat-value text-green-600" id="stat-reconciled-amt">0.00</div>
                        </div>
                    </div>

                    <div class="bg-white rounded shadow-sm overflow-auto">
                        <div class="px-4 py-2 border-b bg-gray-50 text-xs font-bold text-gray-500 uppercase flex justify-between">
                            <span>比对信息总览</span>
                        </div>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">序号</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">比对时间</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">对账状态总览</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                            </thead>
                            <tbody id="mini-overview-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded shadow-sm flex flex-col min-h-0">
                    <div class="p-3 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">已对账账单列表</h3>
                        <div class="flex items-center space-x-2">
                            <input id="recon-filter-order" type="text" placeholder="订单编号" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            <input id="recon-filter-start" type="text" placeholder="缴费开始时间" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            <input id="recon-filter-end" type="text" placeholder="缴费结束时间" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            <select id="recon-filter-status" class="border border-gray-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-blue-400">
                                <option value="">比对状态</option>
                                <option value="success">成功</option>
                                <option value="fail">失败</option>
                            </select>
                            <button onclick="renderReconciledTable()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1.5 rounded">查询</button>
                            <button class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-xs px-3 py-1.5 rounded">导出</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="min-w-[1500px] w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-10"><input type="checkbox" class="rounded"></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-16">序号</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">对账日期</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">比对时间</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">订单编号</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">银行交易金额</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">系统订单金额</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">银行是否退款</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">缴费状态</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">退款时间</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">缴费时间</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">比对状态</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase sticky right-0 bg-gray-50 shadow-sm">操作</th>
                                </tr>
                            </thead>
                            <tbody id="reconciled-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="p-2 border-t flex justify-end items-center text-xs text-gray-600">
                        <span class="mr-4">共 <span id="recon-total">0</span> 条</span>
                        <select class="border rounded px-1 py-0.5 mr-2"><option>10条/页</option></select>
                        <button class="border rounded px-2 py-0.5 mr-1 bg-gray-50">&lt;</button>
                        <span class="mx-1">1</span>
                        <button class="border rounded px-2 py-0.5 ml-1 bg-gray-50">&gt;</button>
                        <span class="ml-2 mr-1">前往</span><input type="text" value="1" class="border rounded w-8 text-center py-0.5"><span class="ml-1">页</span>
                    </div>
                </div>
            </div>

            <div id="view-unrecon" class="flex flex-col h-full hidden space-y-4">
                
                <div class="flex justify-between items-center bg-white p-3 rounded shadow-sm shrink-0">
                    <h2 class="text-lg font-bold text-gray-800">未对账账单看板</h2>
                </div>

                <div class="grid grid-cols-2 gap-4 shrink-0" style="height: 180px;">
                    <div class="grid grid-cols-2 grid-rows-2 gap-3 h-full">
                        <div class="stat-card border-l-orange-500">
                            <div class="stat-label">滞留帐单数</div>
                            <div class="stat-value text-orange-600" id="stat-unrec-count">0</div>
                        </div>
                        <div class="stat-card border-l-red-500">
                            <div class="stat-label">滞留多日帐单数</div>
                            <div class="stat-value text-red-600" id="stat-unrec-retention-count">0</div>
                        </div>
                        <div class="stat-card border-l-gray-500">
                            <div class="stat-label">滞留账单总金额</div>
                            <div class="stat-value text-gray-800" id="stat-unrec-amt">0.00</div>
                        </div>
                        <div class="stat-card border-l-blue-500">
                            <div class="stat-label">待跑批帐单数</div>
                            <div class="stat-value text-blue-600" id="stat-unrec-pending-count">0</div>
                        </div>
                    </div>

                    <div class="bg-white rounded shadow-sm overflow-hidden flex flex-col">
                        <div class="px-4 py-2 border-b bg-gray-50 text-xs font-bold text-gray-500 uppercase flex justify-between items-center">
                            <span>滞留账单检测通知</span>
                            <div class="flex items-center space-x-2">
                                <label class="text-gray-400 font-normal">推送时间:</label>
                                <input id="unrec-notif-date" type="date" value="2025-12-06" class="border border-gray-300 rounded px-2 py-0.5 text-xs font-normal">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-0.5 rounded" onclick="renderUnreconMiniList()">查询</button>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">序号</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase bg-blue-50">通知内容</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">通知创建时间</th>
                                    </tr>
                                </thead>
                                <tbody id="mini-unrecon-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="flex-1 bg-white rounded shadow-sm flex flex-col min-h-0">
                    <div class="p-3 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">未对账账单列表</h3>
                        <div class="flex items-center space-x-2">
                            <input id="unrec-filter-order" type="text" placeholder="订单编号" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            <input id="unrec-filter-start" type="text" placeholder="缴费开始时间" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            <input id="unrec-filter-end" type="text" placeholder="缴费结束时间" class="border border-gray-300 rounded px-2 py-1 text-sm w-32 focus:outline-none focus:border-blue-400">
                            
                            <select id="unrec-filter-status" class="border border-gray-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-blue-400">
                                <option value="">比对状态</option>
                                <option value="pending">待跑批</option>
                                <option value="retention">滞留</option>
                            </select>
                            
                            <select id="unrec-filter-retention" class="border border-gray-300 rounded px-2 py-1 text-sm w-24 focus:outline-none focus:border-blue-400">
                                <option value="">滞留天数</option>
                                <option value="0">滞留0日</option>
                                <option value="1">滞留1日</option>
                                <option value="2">滞留2日</option>
                                <option value="3">滞留3日</option>
                                <option value="multi">滞留多日</option>
                            </select>
                            <button onclick="renderUnreconciledTable()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1.5 rounded">查询</button>
                            <button class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-xs px-3 py-1.5 rounded">导出</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="min-w-[1400px] w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-10"><input type="checkbox" class="rounded"></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-16">序号</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">订单编号</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">系统订单金额</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">缴费状态</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">退款时间</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">缴费时间</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">比对状态</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">滞留天数</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase sticky right-0 bg-gray-50 shadow-sm">操作</th>
                                </tr>
                            </thead>
                            <tbody id="unreconciled-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div class="p-2 border-t flex justify-end items-center text-xs text-gray-600">
                        <span class="mr-4">共 <span id="unrecon-total">0</span> 条</span>
                        <select class="border rounded px-1 py-0.5 mr-2"><option>10条/页</option></select>
                        <button class="border rounded px-2 py-0.5 mr-1 bg-gray-50">&lt;</button>
                        <span class="mx-1">1</span>
                        <button class="border rounded px-2 py-0.5 ml-1 bg-gray-50">&gt;</button>
                        <span class="ml-2 mr-1">前往</span><input type="text" value="1" class="border rounded w-8 text-center py-0.5"><span class="ml-1">页</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center hidden z-[999]">
        <div class="bg-white rounded w-[900px] flex flex-col shadow-2xl max-h-[90vh]">
            <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">账单详情</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none text-2xl leading-none">&times;</button>
            </div>
            <div id="modal-content-body" class="p-6 overflow-y-auto"></div>
            <div class="flex justify-end px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b">
                <button onclick="closeModal()" class="px-6 py-1.5 bg-white text-gray-600 text-sm rounded border border-gray-300 hover:bg-gray-100 shadow-sm">取消</button>
            </div>
        </div>
    </div>

    <script>
        // --- Navigation ---
        function switchPage(page) {
            const navRecon = document.getElementById('nav-recon');
            const navUnrecon = document.getElementById('nav-unrecon');
            const viewRecon = document.getElementById('view-recon');
            const viewUnrecon = document.getElementById('view-unrecon');

            if (page === 'recon') {
                navRecon.classList.add('active'); navUnrecon.classList.remove('active');
                navRecon.querySelector('span').classList.replace('bg-gray-400', 'bg-blue-500');
                navUnrecon.querySelector('span').classList.replace('bg-blue-500', 'bg-gray-400');
                viewRecon.classList.remove('hidden'); viewUnrecon.classList.add('hidden');
                refreshViews();
            } else {
                navRecon.classList.remove('active'); navUnrecon.classList.add('active');
                navRecon.querySelector('span').classList.replace('bg-blue-500', 'bg-gray-400');
                navUnrecon.querySelector('span').classList.replace('bg-gray-400', 'bg-blue-500');
                viewRecon.classList.add('hidden'); viewUnrecon.classList.remove('hidden');
                renderUnreconciledTable();
                renderUnreconStats();
                renderUnreconMiniList();
            }
        }

        // --- Data ---
        const SIMULATED_TODAY = '2025-12-05'; 
        
        // Reconciled View Data
        // Compare Date is uniformly Dec 6
        const overviewConfig = [
            { id: 203, dateTime: '2025-12-04 14:00:00', notifyStatus: 'all_success', step: 0 },
            { id: 101, dateTime: '2025-12-06 08:00:00', notifyStatus: 'all_success', step: 1 },
            { id: 102, dateTime: '2025-12-06 12:00:00', notifyStatus: 'all_fail', step: 2 },
            { id: 103, dateTime: '2025-12-06 14:00:00', notifyStatus: 'part_fail', step: 3 },
        ];

        // Unreconciled View Data (Bank Notification)
        let bankNotificationData = [
            { id: 'bn-1', pushTime: '2025-12-04 17:00:00', multiDayCount: 0 },
            { id: 'bn-2', pushTime: '2025-12-05 17:00:00', multiDayCount: 5 }, // 5 items > 3 days
            { id: 'bn-3', pushTime: '2025-12-06 17:00:00', multiDayCount: 5 } 
        ];
        
        for(let k=0; k<10; k++) {
            bankNotificationData.push({
                id: `bn-old-${k}`,
                pushTime: `2025-12-0${3-k%3} 09:00:00`,
                multiDayCount: 0
            });
        }
        bankNotificationData.sort((a,b) => b.pushTime.localeCompare(a.pushTime));

        let simulationStep = 0; 
        let viewingStep = null;

        // Unreconciled Items
        let unreconciledData = [];
        
        // 1. Dec 6 Item (Retention -)
        unreconciledData.push({
            id: 'unrec-1', displayId: 1, orderNo: 'SYS20251206001', sysAmt: '50.00', 
            paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-06 09:30:00', 
            retentionDays: '-', unrecStatus: '待跑批' 
        });

        // 2. Retention 0 (Pay Dec 5)
        for(let i=0; i<3; i++) {
            unreconciledData.push({
                id: `unrec-ret0-${i}`, displayId: 2+i, orderNo: `SYS2025120500${i}`, sysAmt: '50.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-05 10:00:00', 
                retentionDays: '0', unrecStatus: '滞留' 
            });
        }

        // 3. Retention 1 (Pay Dec 4)
        for(let i=0; i<3; i++) {
            unreconciledData.push({
                id: `unrec-ret1-${i}`, displayId: 5+i, orderNo: `SYS2025120400${i}`, sysAmt: '50.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-04 14:00:00', 
                retentionDays: '1', unrecStatus: '滞留' 
            });
        }

        // 4. Retention 2 (Pay Dec 3)
        for(let i=0; i<3; i++) {
            unreconciledData.push({
                id: `unrec-ret2-${i}`, displayId: 8+i, orderNo: `SYS2025120300${i}`, sysAmt: '50.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-03 11:00:00', 
                retentionDays: '2', unrecStatus: '滞留'
            });
        }

        // 5. Retention 3 (Pay Dec 2)
        for(let i=0; i<3; i++) {
            unreconciledData.push({
                id: `unrec-ret3-${i}`, displayId: 11+i, orderNo: `SYS2025120200${i}`, sysAmt: '50.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-02 09:00:00', 
                retentionDays: '3', unrecStatus: '滞留'
            });
        }

        // 6. Retention > 3 (4 & 5) - (Strictly > 3 = 4, 5...)
        // 2 items Ret 4 (Pay Dec 1)
        for(let i=0; i<2; i++) {
            unreconciledData.push({
                id: `unrec-ret4-${i}`, displayId: 14+i, orderNo: `SYS2025120100${i}`, sysAmt: '200.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-12-01 09:00:00', 
                retentionDays: '4', unrecStatus: '滞留'
            });
        }
        // 3 items Ret 5 (Pay Nov 30)
        for(let i=0; i<3; i++) {
            unreconciledData.push({
                id: `unrec-ret5-${i}`, displayId: 16+i, orderNo: `SYS2025113000${i}`, sysAmt: '200.00', 
                paymentStatus: '已缴费', refundTime: '-', payTime: '2025-11-30 09:00:00', 
                retentionDays: '5', unrecStatus: '滞留'
            });
        }

        function getNextDayDateStr(dateStr) {
            let date = new Date(dateStr); date.setDate(date.getDate() + 1);
            let y = date.getFullYear(); let m = String(date.getMonth() + 1).padStart(2, '0'); let d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getDec5Snapshot(step) {
            const billDate = '2025-12-05';
            // Unified compare date time to Dec 6
            const compareDate = `2025-12-06 ${step===1?'08:00:00':(step===2?'12:00:00':'14:00:00')}`;

            let items = [];
            for (let i = 1; i <= 10; i++) {
                let item = {
                    id: `dec5-${i}`, displayId: i, recDate: billDate, compareDate: compareDate,
                    orderNo: `SYS${billDate.replace(/-/g, '')}00${i}`, bankAmt: '100.00', sysAmt: '100.00', 
                    payTime: `${billDate} 09:0${i}:00`, refundTime: '-', paymentStatus: '已缴费', 
                    matchStatus: 'success', orderRefund: '否', delayDays: 0, isUnreconciled: false
                };

                if (i === 6) {
                    item.bankAmt = '100.00'; item.matchStatus = 'success'; item.delayDays = 1;
                }
                else if (i === 7) {
                    item.bankAmt = '100.00'; item.orderRefund = '否'; item.matchStatus = 'success'; item.delayDays = 0;
                }
                else if (i === 2) {
                    if (step === 1) { 
                        item.orderNo = `SYS${billDate.replace(/-/g, '')}00${i}`; 
                        item.sysAmt = '-'; item.payTime = '-'; item.paymentStatus = '-'; item.refundTime='-';
                        item.matchStatus = 'fail';
                    }
                }
                else if (i === 3) {
                    if (step < 3) { item.sysAmt = '90.00'; item.matchStatus = 'fail'; }
                }
                else if (i === 4) {
                    if (step === 1) { item.paymentStatus = '未缴费'; item.matchStatus = 'fail'; }
                }
                else if (i === 9) {
                    item.orderNo = 'SYS20251205009'; item.paymentStatus = '已退款'; 
                    item.refundTime = '2025-12-05 09:10:00'; item.payTime = '2025-12-05 09:09:00';
                }
                else if (i === 10) {
                    item.orderNo = 'SYS20251205009'; item.orderRefund = '是'; item.paymentStatus = '已退款'; 
                    item.refundTime = '2025-12-05 09:10:00'; item.payTime = '2025-12-05 09:09:00';
                }

                items.push(item);
            }
            return items;
        }

        // *** CORE CHANGE: Get Current Data Context for Sync ***
        function getCurrentReconciledItems() {
            const filterDate = document.getElementById('overview-date-filter').value;
            let items = [];

            if (filterDate === '2025-12-04') {
                items = [{ bankAmt: '100.00', matchStatus: 'success', orderRefund: '否' }];
            } else if (filterDate === '2025-12-05') {
                // Determine step: if viewingStep is active, use it; otherwise use simulationStep
                let step = viewingStep !== null ? viewingStep : simulationStep;
                if (step > 0) items = getDec5Snapshot(step);
            }
            return items;
        }

        function viewSnapshot(step) {
            viewingStep = step;
            refreshViews(); // Triggers renderDashboard and renderReconciledTable with new context
        }

        function refreshViews() {
            renderDashboard();
            renderMiniList();
            renderReconciledTable();
        }

        // --- RECONCILED VIEW RENDERERS ---

        function renderDashboard() {
            // Updated to use shared data source for sync
            const items = getCurrentReconciledItems();

            let bankCount = 0, abnormalCount = 0, reconciledAmt = 0, totalAmt = 0;

            items.forEach(d => {
                const bAmt = parseFloat(d.bankAmt) || 0;
                let realAmt = (d.orderRefund === '是') ? -bAmt : bAmt;
                if (d.bankAmt !== '-') { bankCount++; totalAmt += realAmt; }
                if (d.matchStatus === 'fail') abnormalCount++;
                else reconciledAmt += realAmt;
            });

            document.getElementById('stat-bank-count').textContent = bankCount;
            document.getElementById('stat-abnormal-count').textContent = abnormalCount;
            document.getElementById('stat-reconciled-amt').textContent = reconciledAmt.toFixed(2);
            document.getElementById('stat-total-amt').textContent = totalAmt.toFixed(2);
        }

        function renderMiniList() {
            const tbody = document.getElementById('mini-overview-body');
            tbody.innerHTML = '';
            
            const filterDate = document.getElementById('overview-date-filter').value;
            let list = [];

            if (filterDate === '2025-12-04') list.push(overviewConfig[0]);
            else if (filterDate === '2025-12-05') {
                if (simulationStep >= 1) list.push(overviewConfig[1]);
                if (simulationStep >= 2) list.push(overviewConfig[2]);
                if (simulationStep >= 3) list.push(overviewConfig[3]);
            }

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">无数据</td></tr>';
                return;
            }

            // Reverse for display (Newest First)
            list.sort((a, b) => b.dateTime.localeCompare(a.dateTime));

            list.forEach((conf, idx) => {
                let items = (filterDate === '2025-12-05') ? getDec5Snapshot(conf.step) : [{ matchStatus: 'success' }];
                let failCount = items.filter(i => i.matchStatus === 'fail').length;
                let statusHtml = failCount > 0 
                    ? '<span class="text-red-500 font-medium">对账失败</span>' 
                    : '<span class="text-green-600 font-medium">对账成功</span>';

                let opHtml = `<span class="btn-blue-text" onclick="viewSnapshot(${conf.step})">[查看]</span>`;
                
                // Fixed ID generation to 1, 2, 3...
                let row = `<tr class="hover:bg-gray-50 border-b border-gray-100 ${viewingStep === conf.step ? 'viewing-row' : ''}">
                    <td class="px-4 py-2 text-sm">${idx + 1}</td>
                    <td class="px-4 py-2 text-sm">${conf.dateTime}</td>
                    <td class="px-4 py-2 text-center text-sm">${statusHtml}</td>
                    <td class="px-4 py-2 text-center text-sm">${opHtml}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderReconciledTable() {
            const tbody = document.getElementById('reconciled-body');
            tbody.innerHTML = '';
            
            // Updated to use shared data source for sync
            let items = getCurrentReconciledItems();

            const orderFilter = document.getElementById('recon-filter-order').value.toLowerCase();
            const timeStartFilter = document.getElementById('recon-filter-start').value;
            const timeEndFilter = document.getElementById('recon-filter-end').value;
            const statusFilter = document.getElementById('recon-filter-status').value;

            if (orderFilter) items = items.filter(i => i.orderNo.toLowerCase().includes(orderFilter));
            if (timeStartFilter) items = items.filter(i => i.payTime >= timeStartFilter);
            if (timeEndFilter) items = items.filter(i => i.payTime <= timeEndFilter);
            if (statusFilter) items = items.filter(i => i.matchStatus === statusFilter);

            document.getElementById('recon-total').textContent = items.length;

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4 text-gray-400">暂无数据</td></tr>';
                return;
            }

            items.forEach((item, idx) => {
                const statusHtml = item.matchStatus === 'success' ? '<span class="text-green-500">成功</span>' : '<span class="text-red-500">失败</span>';
                const opHtml = `<span class="btn-blue-text" onclick="openDetailModal('${item.id}', 'recon', '${item.matchStatus}', '${item.orderNo}', '${item.bankAmt}', '${item.sysAmt}', '${item.orderRefund}', '${item.paymentStatus}', '${item.delayDays}', '否')">[详情]</span>`;

                const row = `<tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-3 text-center"><input type="checkbox" class="rounded"></td>
                    <td class="px-4 py-3 text-sm text-gray-900">${idx+1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.recDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.compareDate}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.orderNo}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">${item.bankAmt}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">${item.sysAmt}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-900">${item.orderRefund}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-900">${item.paymentStatus}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.refundTime}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.payTime}</td>
                    <td class="px-4 py-3 text-center text-sm font-medium">${statusHtml}</td>
                    <td class="px-4 py-3 text-center text-sm sticky right-0 bg-white border-l shadow-sm">${opHtml}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // --- UNRECONCILED VIEW RENDERERS ---

        function getUnreconciledDataFiltered() {
            let items = [...unreconciledData];
            const orderFilter = document.getElementById('unrec-filter-order').value.toLowerCase();
            const timeStartFilter = document.getElementById('unrec-filter-start').value;
            const timeEndFilter = document.getElementById('unrec-filter-end').value;
            const retentionFilter = document.getElementById('unrec-filter-retention').value;
            const statusFilter = document.getElementById('unrec-filter-status').value;

            if (orderFilter) items = items.filter(i => i.orderNo.toLowerCase().includes(orderFilter));
            if (timeStartFilter) items = items.filter(i => i.payTime >= timeStartFilter);
            if (timeEndFilter) items = items.filter(i => i.payTime <= timeEndFilter);
            
            if (statusFilter) {
                if (statusFilter === 'pending') items = items.filter(i => i.unrecStatus === '待跑批');
                if (statusFilter === 'retention') items = items.filter(i => i.unrecStatus === '滞留');
            }

            if (retentionFilter) {
                items = items.filter(i => {
                    if (retentionFilter === '0') return i.retentionDays === '0';
                    if (retentionFilter === '1') return i.retentionDays === '1';
                    if (retentionFilter === '2') return i.retentionDays === '2';
                    if (retentionFilter === '3') return i.retentionDays === '3';
                    if (retentionFilter === 'multi') return parseInt(i.retentionDays) > 3;
                    return true;
                });
            }
            return items;
        }

        function renderUnreconStats() {
            const items = getUnreconciledDataFiltered();
            const fullItems = unreconciledData; 

            let retentionCount = 0; 
            let pendingCount = 0;   
            let multiDayCount = 0;  
            let totalAmt = 0;

            fullItems.forEach(d => {
                if (d.unrecStatus === '滞留') {
                    retentionCount++;
                    totalAmt += parseFloat(d.sysAmt);
                }
                if (d.unrecStatus === '待跑批') pendingCount++;
                if (parseInt(d.retentionDays) > 3) multiDayCount++; // Strict logic: > 3
            });
            
            document.getElementById('stat-unrec-count').textContent = retentionCount;
            document.getElementById('stat-unrec-amt').textContent = totalAmt.toFixed(2);
            document.getElementById('stat-unrec-pending-count').textContent = pendingCount;
            document.getElementById('stat-unrec-retention-count').textContent = multiDayCount;
        }

        function renderUnreconMiniList() {
            const tbody = document.getElementById('mini-unrecon-body');
            tbody.innerHTML = '';
            
            let list = [];
            const filterDate = document.getElementById('unrec-notif-date').value;
            list = bankNotificationData.filter(item => item.pushTime.startsWith(filterDate));

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400">无数据</td></tr>';
                return;
            }

            list.forEach((conf, idx) => {
                // FIXED: Data order matches Header order
                // Header: Seq | Content | Time
                let row = `<tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-2 text-sm">${idx + 1}</td>
                    <td class="px-4 py-2 text-center text-sm font-bold text-gray-700">已滞留多日账单数${conf.multiDayCount}条</td>
                    <td class="px-4 py-2 text-left text-sm text-gray-500">${conf.pushTime}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderUnreconciledTable() {
            const tbody = document.getElementById('unreconciled-body');
            tbody.innerHTML = '';
            const items = getUnreconciledDataFiltered();

            document.getElementById('unrecon-total').textContent = items.length;

            items.forEach((item, idx) => {
                let statusHtml = '';
                if(item.unrecStatus === '待跑批') statusHtml = '<span class="text-blue-500">待跑批</span>';
                else if(item.unrecStatus === '滞留') statusHtml = '<span class="text-orange-500">滞留</span>';

                let retentionStr = item.retentionDays; 

                const opHtml = `
                    <span class="btn-blue-text mr-2" onclick="openDetailModal('${item.id}', 'unrec', 'unreconciled', '${item.orderNo}', '-', '${item.sysAmt}', '-', '${item.paymentStatus}', '${item.retentionDays}', '${item.unrecStatus}')">[详情]</span>
                `;

                const row = `<tr class="hover:bg-gray-50 border-b border-gray-100">
                    <td class="px-4 py-3 text-center"><input type="checkbox" class="rounded"></td>
                    <td class="px-4 py-3 text-sm text-gray-900">${idx+1}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.orderNo}</td>
                    <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">${item.sysAmt}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-900">${item.paymentStatus}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.refundTime}</td>
                    <td class="px-4 py-3 text-sm text-gray-500">${item.payTime}</td>
                    <td class="px-4 py-3 text-center text-sm font-medium">${statusHtml}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-900">${retentionStr}</td>
                    <td class="px-4 py-3 text-center text-sm sticky right-0 bg-white border-l shadow-sm">${opHtml}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        document.getElementById('btn-sys-reconcile').addEventListener('click', () => {
            if(simulationStep < 3) {
                simulationStep++;
                viewingStep = null; 
                refreshViews();
            } else {
                alert("模拟结束");
            }
        });

        document.getElementById('btn-query-recon').addEventListener('click', () => {
            refreshViews();
        });

        window.onload = function() {
            document.getElementById('overview-date-filter').value = SIMULATED_TODAY;
            refreshViews();
            renderUnreconMiniList();
        };

        // --- Modal ---
        function openDetailModal(id, type, status, orderNo, bankAmt, sysAmt, bankRefund, payStatus, delayDays, unrecStatus) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('modal-content-body');
            let statusText = status === 'success' ? '成功' : (status === 'fail' ? '失败' : unrecStatus);
            let retText = delayDays;
            if(retText !== '-' && retText !== undefined) retText = retText;

            let matchInfoHtml = '';
            if (type === 'unrec') {
                matchInfoHtml = `
                    <div class="info-label">滞留天数</div><div class="info-value">${retText}</div>
                    <div class="info-label">比对状态</div><div class="info-value">${statusText}</div>
                    <div class="info-label"></div><div class="info-value"></div>
                `;
            } else {
                matchInfoHtml = `
                    <div class="info-label">比对状态</div><div class="info-value">${statusText}</div>
                `;
            }

            const html = `
                <div class="space-y-0">
                    <div class="modal-section-title">对账信息</div>
                    <div class="info-grid">
                        <div class="info-label">对账日期</div><div class="info-value">2025-12-05</div>
                        <div class="info-label">比对时间</div><div class="info-value">2025-12-06 12:00:00</div>
                        <div class="info-label">订单编号</div><div class="info-value">${orderNo}</div>
                        <div class="info-label">银行交易金额</div><div class="info-value">${bankAmt}</div>
                        <div class="info-label">系统订单金额</div><div class="info-value">${sysAmt}</div>
                        <div class="info-label">银行是否退款</div><div class="info-value">${bankRefund}</div>
                        <div class="info-label">缴费状态</div><div class="info-value">${payStatus}</div>
                        <div class="info-label">退款时间</div><div class="info-value">-</div>
                        <div class="info-label">缴费时间</div><div class="info-value">2025-12-05 09:09:00</div>
                        ${matchInfoHtml}
                    </div>
                    
                    <div class="modal-section-title mt-4">基本信息</div>
                    <div class="info-grid">
                        <div class="info-label">账单生成时间</div><div class="info-value">2025-12-01 10:00:00</div>
                        <div class="info-label">账单状态</div><div class="info-value">正常</div>
                        <div class="info-label">退款失败原因</div><div class="info-value">-</div>
                        <div class="info-label">收费对象类型</div><div class="info-value">单位</div>
                        <div class="info-label">详细分类</div><div class="info-value">私营企业</div>
                        <div class="info-label">所属片区</div><div class="info-value">古城片区（城北）</div>
                        <div class="info-label">账单编号</div><div class="info-value">BILL20251201001</div>
                        <div class="info-label">契约编号</div><div class="info-value">CON2025001</div>
                        <div class="info-label">契约名称</div><div class="info-value">2025年度餐饮垃圾清运合同</div>
                        <div class="info-label">合同开始时间</div><div class="info-value">2025-01-01</div>
                        <div class="info-label">合同截至时间</div><div class="info-value">2025-12-31</div>
                        <div class="info-label">身份证号码</div><div class="info-value">440103199001011234</div>
                        <div class="info-label">社会信用代码</div><div class="info-value">91440300MA5F123456</div>
                        <div class="info-label">收费对象姓名</div><div class="info-value">李华</div>
                        <div class="info-label border-b border-gray-200">联系电话</div><div class="info-value border-b border-gray-200">13800138000</div>
                        <div class="info-label bg-white border-none"></div><div class="info-value border-none"></div>
                        <div class="info-label">资源地址</div><div class="info-value col-span-3">江西省九江市某某路某号</div>
                    </div>

                    <div class="modal-section-title mt-4">费用信息</div>
                    <div class="info-grid">
                        <div class="info-label">账单周期</div><div class="info-value">2025-11-01 至 2025-11-30</div>
                        <div class="info-label">缴费周期数</div><div class="info-value">1</div>
                    </div>
                </div>
            `;
            content.innerHTML = html;
            modal.classList.remove('hidden');
        }
        window.closeModal = () => document.getElementById('detail-modal').classList.add('hidden');
    </script>
</body>
</html>